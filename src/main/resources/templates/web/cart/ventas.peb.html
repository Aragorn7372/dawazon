{% include "common/header" %}
{% include "common/navbar" %}
<header class="bg-custom-dark p-2">
    <div class="container d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center gap-3">
            <h5 class="mb-0 text-white">Mi servicio — Ventas</h5>
        </div>
        <form class="d-flex flex-grow-1" action="/" method="get" role="search">
            <div class="d-flex align-items-center gap-2">
                <input id="globalSearch" class="form-control search-input" name="codigo" type="search"
                       placeholder="Buscar código" value="{{ codigo | default('')}}" style="width: 300px;">
                <button id="btnSearch" type="submit" class="btn btn-search">Buscar</button>
            </div>
        </form>
    </div>
</header>
<main class="container col-12">
    <h2 class="product-title">Listado de ventas</h2>

    <!-- Filtros rápidos y acciones -->
    <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
        <div class="d-flex gap-2 align-items-center">
            <select id="filterState" class="form-select form-select-sm" style="width: 200px;">
                <option value="">Filtro: Todos los estados</option>
                <option value="completada">Completada</option>
                <option value="pendiente">Pendiente</option>
                <option value="cancelada">Cancelada</option>
            </select>
        </div>

        <div class="text-end text-muted-small">
            Mostrando <span id="shownCount">0</span> de <span id="totalCount">0</span> ventas
        </div>
    </div>

    <!-- Tabla de ventas -->
    <div class="table-responsive">
        <table id="salesTable" class="table users-table align-middle">
            <thead>
            <tr>
                <th scope="col">Código</th>
                <th scope="col">Cliente</th>
                <th scope="col">Estado</th>
                <th scope="col">Precio</th>
                <th scope="col" class="text-end">Acciones</th>
            </tr>
            </thead>
            <tbody id="salesTbody">
            {% for venta in ventas %}

            <tr data-index="0">
                <td class="align-middle"><a class="text-decoration-none text-black" href="/ventas/{{venta.getId}}">{{venta.getId}}</a>
                </td>
                <td>
                    <div class="d-flex align-items-center gap-2">
                        <img class="avatar-small" src="{{venta.UserAvatar}}" alt="">
                        <div>
                            <span class="client-name">{{venta.getUserName}}</span>
                            <span class="client-email">{{venta.getUserEmail}}</span>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="status-badge status-{{venta.getStatus}}">{{venta.getStatus}}</span>
                </td>
                <td class="align-middle">{{venta.getPrice}}</td>
                <td class="text-end align-middle actions-cell">
                    <button class="btn-action btn-edit me-2" onclick="edit({{isAdmin}},{{venta.getId}})"
                            data-action="edit" title="Editar"
                            data-index="0">
                        <i class="fa-solid fa-pen-to-square">Editar</i>
                    </button>
                    <button class="btn-action btn-delete" onclick="cancelVenta({{isAdmin}},{{venta.getId}})"
                            data-action="delete" title="Eliminar" data-index="0">
                        <i class="fa-solid bi bi-trash"></i>
                    </button>
                </td>
            </tr>

            {% endfor %}
            </tbody>
            <tfoot>
            <tr class="total-row">
                <td colspan="3" class="text-end fw-bold">Ganancias totales:</td>
                <td id="totalAmount" class="fw-bold">{{ganancias}}</td>
            </tr>
            </tfoot>
        </table>
    </div>
    <nav aria-label="Paginación ventas" class="mt-3">
        <ul id="pagination" class="pagination pagination-sm justify-content-end mb-0"></ul>
    </nav>
</main>

<script>
    function cancelVenta(boolean, ventaId) {
        if (boolean == false) {
            window.location.href = `/auth/me/ventas/cancel/${ventaId}`;
        } else {
            window.location.href = `/ventas/cancel/${ventaId}`;
        }
    }

    function edit(boolean, ventaId) {
        if (boolean == false) {
            window.location.href = `/auth/me/ventas/edit/${ventaId}`;
        } else {
            window.location.href = `/ventas/edit/${ventaId}`;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const tbody = document.getElementById('salesTbody');
        const shownEl = document.getElementById('shownCount');
        const totalEl = document.getElementById('totalCount');
        const filterEl = document.getElementById('filterState');
        const searchEl = document.getElementById('globalSearch'); // si existe en tu layout

        if (!tbody || !shownEl || !totalEl) return;

        // Devuelve todas las filas TR actualmente en el tbody
        function allRows() {
            return Array.from(tbody.querySelectorAll('tr'));
        }

        // Cuenta las filas que están visibles (no display: none)
        function countVisibleRows() {
            const rows = allRows();
            const visible = rows.filter(r => {
                // offsetParent es null cuando el elemento o alguno de sus ancestros tiene display:none
                if (r.offsetParent === null) return false;
                const cs = getComputedStyle(r);
                return cs.display !== 'none' && cs.visibility !== 'hidden' && cs.opacity !== '0';
            }).length;
            shownEl.textContent = visible;
            totalEl.textContent = rows.length;
        }

        // Filtrado simple por estado usando el contenido textual de .status-badge
        function applyStateFilter() {
            const val = filterEl ? filterEl.value.trim().toLowerCase() : '';
            allRows().forEach(row => {
                const statusEl = row.querySelector('.status-badge');
                const statusText = statusEl ? statusEl.textContent.trim().toLowerCase() : '';
                // Si no hay filtro o la fila coincide con el filtro, se muestra; si no, se oculta
                if (!val || statusText === val) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            countVisibleRows();
        }

        // Filtrado de búsqueda (si existe un input #globalSearch); busca en el texto de la fila
        function applySearchFilter() {
            if (!searchEl) return;
            const q = searchEl.value.trim().toLowerCase();
            allRows().forEach(row => {
                const text = row.textContent.toLowerCase();
                // Mantener la fila solo si contiene la query
                if (!q || text.includes(q)) {
                    // No forzamos mostrar aquí; dejamos que el filtro de estado decida finalmente.
                    row.dataset._matchesSearch = '1';
                } else {
                    row.dataset._matchesSearch = '0';
                }
            });
            // Aplicar la combinación: mostrar solo si matchesSearch === '1' y estado coincide
            const val = filterEl ? filterEl.value.trim().toLowerCase() : '';
            allRows().forEach(row => {
                const matchesSearch = row.dataset._matchesSearch !== '0';
                const statusEl = row.querySelector('.status-badge');
                const statusText = statusEl ? statusEl.textContent.trim().toLowerCase() : '';
                const matchesState = !val || statusText === val;
                row.style.display = (matchesSearch && matchesState) ? '' : 'none';
            });
            countVisibleRows();
        }

        // Debounce util
        function debounce(fn, wait = 200) {
            let t;
            return (...args) => {
                clearTimeout(t);
                t = setTimeout(() => fn.apply(this, args), wait);
            };
        }

        // Inicial: si el servidor ya ha renderizado filas, ajustar contadores
        countVisibleRows();

        // Listeners
        if (filterEl) {
            filterEl.addEventListener('change', () => {
                // si existe búsqueda activa, la tendremos en cuenta
                if (searchEl && searchEl.value.trim().length > 0) {
                    applySearchFilter();
                } else {
                    applyStateFilter();
                }
            });
        }

        if (searchEl) {
            searchEl.addEventListener('input', debounce(() => {
                applySearchFilter();
            }, 180));
        }

        // Si el tbody cambia (rows añadidas/eliminadas o cambio de contenido), actualizar contador
        const mo = new MutationObserver(mutations => {
            // pequeña protección: si cambian atributos de estilo, también recuenta
            countVisibleRows();
        });
        mo.observe(tbody, {childList: true, subtree: true, attributes: true, attributeFilter: ['style', 'class']});

        // Exponer función en window por si la necesitas desde otro script
        window.updateVentasCounters = countVisibleRows;
    });
</script>
{% include "common/footer" %}
